# Modern Jamaica ランキングシステム設計書

## 概要

Modern Jamaica パズルゲームにおけるランキング機能とユーザー管理システムの設計仕様書です。

## 機能要件

### 基本要件

- 3 つの難易度レベル（かんたん/ふつう/むずかしい）別のランキング
- 上位 10 名の表示
- ユーザー名、スコア、プレイ日時の表示
- 重複防止（同一ユーザーは最高スコアのみ）
- リアルタイム更新
- Firebase 無料枠での運用
- 数万ユーザーまでスケール可能

## データ構造設計

### 1. ユーザーデータ構造

```
UserScoreDocument {
  userId: string           // ユニークユーザーID
  displayName: string      // 表示名
  createdAt: number        // 初回登録日時（タイムスタンプ）
  lastUpdated: number      // 最終更新日時（タイムスタンプ）
  challengeScores: {
    easy: ChallengeScore     // かんたんモードのスコア
    normal: ChallengeScore   // ふつうモードのスコア
    hard: ChallengeScore     // むずかしいモードのスコア
  }
}
```

### 2. スコアデータ構造

```
ChallengeScore {
  score: number            // 達成問題数
  timestamp: number        // 記録日時
  problemCount: number     // 総問題数（追加情報用）
}
```

### 3. ランキング表示用データ構造

```
ChallengeRankingEntry {
  rank: number             // 順位
  userId: string           // ユーザーID
  displayName: string      // 表示名
  score: number            // スコア
  problemCount: number     // 問題数
  timestamp: number        // 記録日時
  isCurrentUser?: boolean  // 現在のユーザーかどうか
}
```

## Firestore コレクション設計

### コレクション名: `userScores`

- **ドキュメント ID**: userId
- **インデックス**:
  - `challengeScores.easy.score` (降順)
  - `challengeScores.normal.score` (降順)
  - `challengeScores.hard.score` (降順)

### 例：Firestore ドキュメント

```
userScores/user_1234567890_abc123def {
  userId: "user_1234567890_abc123def",
  displayName: "プレイヤー太郎",
  createdAt: 1704067200000,
  lastUpdated: 1704153600000,
  challengeScores: {
    easy: {
      score: 15,
      timestamp: 1704153600000,
      problemCount: 15
    },
    normal: {
      score: 8,
      timestamp: 1704140000000,
      problemCount: 10
    },
    hard: {
      score: 3,
      timestamp: 1704067200000,
      problemCount: 5
    }
  }
}
```

## ユーザーフロー設計

### 1. 初回プレイ時

```
ゲーム開始
↓
ユーザーID自動生成（端末ローカル）
- 形式: user_{timestamp}_{random}
- AsyncStorageに保存
↓
ニックネーム入力画面
↓
初回プレイ
↓
スコア記録（Firestore）
```

### 2. 通常プレイ時

```
ゲーム開始
↓
既存ユーザーID読み込み
↓
難易度選択
↓
ゲームプレイ
↓
スコア計算
↓
新記録判定
├─ 新記録の場合 → Firestore更新
└─ 既存記録以下 → 何もしない
↓
結果画面（ランキング変動表示）
```

### 3. ランキング閲覧時

```
ランキング画面表示
↓
難易度タブ選択
↓
上位10名表示
↓
現在ユーザーのハイライト
↓
Pull to Refresh対応
```

### 4. プロフィール変更時

```
設定画面
↓
ニックネーム変更
↓
バリデーション
- 文字数制限（20文字以内）
↓
Firestore更新
```

## 技術仕様

### ユーザー識別方式

**匿名ユーザー方式**

- デバイス固有の ID を生成
- アカウント登録不要
- 端末変更時はデータ引き継ぎ不可

### スコア更新ロジック

**Firestore Transaction を使用**

1. 現在のユーザードキュメント取得
2. 既存スコアと比較
3. 新記録の場合のみ更新
4. アトミックな更新保証

### キャッシュ戦略

**メモリキャッシュ**

- 将来的に追加

### パフォーマンス対策

**読み取り最適化**

- 上位 10 件のみ取得（limit 制限）
- インデックスによる高速ソート

**書き込み最適化**

- 新記録時のみ書き込み
- バッチ処理不要（単発更新）

## セキュリティ考慮事項

### データ保護

- ユーザー ID は推測困難な形式
- 個人識別情報は保存しない
- ニックネームのみ公開情報

### 不正対策

- クライアントサイドでの基本検証
- 将来的なサーバーサイド検証準備

## 運用考慮事項

### Firebase 無料枠内運用

**読み取り制限**

- 1 日 50,000 回まで

**書き込み制限**

- 1 日 20,000 回まで
- 新記録時のみ書き込み

**ストレージ制限**

- 1GB まで
- ユーザー数万人まで対応可能

### スケーラビリティ

**データ増加対応**

- パーティション分割（将来的）
- 古いデータのアーカイブ
- インデックス最適化

## 画面設計

### ランキング画面

```
🏆 ランキング

[かんたん] [ふつう] [むずかしい]  ← タブ

1位  プレイヤー太郎    15問  2024/1/1
2位  ゲーマー花子    14問  2024/1/2
3位  パズル次郎      13問  2024/1/1
...
10位 チャレンジ三郎   8問   2024/1/3

あなたの順位: 15位 (7問)
```

### 結果画面（新記録時）

```
🎉 新記録達成！

スコア: 15問
前回記録: 12問

ランキング: 3位 → 1位 ⬆️

[ランキングを見る] [もう一度]
```

## 今後の拡張可能性

### 追加機能候補

- 週間/月間ランキング
- アチーブメント
- ソーシャル共有

### データ構造拡張

- プレイ履歴の保存
- 統計情報の収集
- パフォーマンス分析

## 実装優先度

### Phase 1（MVP）

1. 基本ランキング機能
2. スコア記録
3. 難易度別表示

### Phase 2（機能拡張）

1. ユーザープロフィール
2. ランキング変動通知
3. 統計情報

### Phase 3（高度機能）

1. ソーシャル機能
2. 詳細分析
3. 運営ツール
